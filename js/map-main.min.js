/*!
 * FlatEarth WebGL v0.0.27  2019-05-06
 * Copyright (C) 2016-2019 T.Seno
 * Copyright (C) 2016-2019 www.flatearthlab.com
 * All rights reserved.
 */

"use strict";function Interpolater(e,t,a,n,i){this.v1=MapMathUtils.toUnitVector3d(e.lambda,e.phi),this.v2=MapMathUtils.toUnitVector3d(t.lambda,t.phi),this.iniViewPos=a,this.finViewPos=n,this.timeSpan=i,this.startTime=null,this.finished=!1}function SlideAnimation(e,t){this.alpha_=e,this.beta_=t,this.time=null,this.velocity=null}function TranslateSlideAnimation(e,t){SlideAnimation.call(this,e,t)}function RotateSlideAnimation(e,t){SlideAnimation.call(this,e,t)}function init(e,t){var a=Math.PI/2,n=canvas.getBoundingClientRect();e.setProjCenter(0,a);var i=RasterMapProjection.createShaderProgram(gl,e),r={width:n.width,height:n.height};mapView=new MapView(i,e,r),loadIcon("./center-pin.png");for(var o=0;o<t.length;o++){var l=t[o];l.visibility=0===o,mapView.addLayer(l)}mapView.addLayer(new GraticuleLayer("LatLongLayer"));var s=mapView.getViewRect(),h=RectangleUtils.getSize(s);mapView.setWindowByCenter([0,0],h),mapView.setRotate(0),mapView.loadData()}function resizeCanvas(e){var t=e.clientWidth,a=e.clientHeight;e.width==t&&e.height==a||(e.width=t,e.height=a)}function loadIcon(e){var t=new Image;t.onload=function(){var e=mapView.createTexture(t);if(e){var a=new PointTextureLayer("centerIcon",ProjShaderProgram.COORD_TYPE_XY,e,{size:48});a.addPoint(0,0),mapView.addLayer(a)}},t.src=e}function makeNEBaseLayer(e){var t={rootNumX:2,rootNumY:1,rootTileSizeX:Math.PI,rootTileSizeY:Math.PI,numLevels:4,tileOrigin:[-Math.PI,-Math.PI/2],inverseY:!1},a={num:50,crossOrigin:"anonymous"},n={opacity:1},i=new TileTextureLayer(e,ProjShaderProgram.COORD_TYPE_DATA,n,t,a);return i.setDataLevelDef(function(e,t){return Math.PI<=e?0:Math.PI/2<=e?1:Math.PI/4<=e?2:3}),i.setTileUrlDef(function(e,t,a){return"https://flatearthlab.sakura.ne.jp/data/20120925/adb12292ed/NE2_50M_SR_W/"+e+"/"+t+"/"+a+".png"}),i}function makeGIBSDataLayer(e,t){var a={rootNumX:2,rootNumY:1,rootTileSizeX:288*Math.PI/180,rootTileSizeY:288*Math.PI/180,numLevels:4,tileOrigin:[-Math.PI,+Math.PI/2],inverseY:!0},n={num:50,crossOrigin:"anonymous"},i={opacity:1},r=new TileTextureLayer(e,ProjShaderProgram.COORD_TYPE_DATA,i,a,n);return r.setDataLevelDef(function(e,t){return Math.PI<=e?0:Math.PI/2<=e?1:Math.PI/4<=e?2:3}),r.setTileUrlDef(function(e,a,n){return t+e+"/"+n+"/"+a+".jpeg"}),r}function makeSelectableBaseLayers(){var e=[];return e.push(makeNEBaseLayer("NEBaseLayer")),e.push(makeGIBSDataLayer("BlueMarble","https://gibs.earthdata.nasa.gov/wmts/epsg4326/best/BlueMarble_ShadedRelief_Bathymetry/default/500m/")),e.push(makeGIBSDataLayer("VIIRS","https://gibs.earthdata.nasa.gov/wmts/epsg4326/best/VIIRS_SNPP_CorrectedReflectance_TrueColor/default/250m/")),e}function makeRadialLinesLayer(e,t,a){for(var n=new PolylineLayer(e,ProjShaderProgram.COORD_TYPE_XY,{color:a}),i=0;i<t.length;++i){for(var r=[],o=t[i]/180*Math.PI,l=Math.cos(o),s=Math.sin(o),h=0;h<=16;h++){var u=Math.PI*h/16;r.push(u*l),r.push(u*s)}n.addPolyline(r)}return n}function makeConcentricCirclesLayer(e,t,a){for(var n=new PolylineLayer(e,ProjShaderProgram.COORD_TYPE_XY,{color:a}),i=0;i<t.length;++i){for(var r=t[i]/6378.137,o=[],l=0;l<=256;l++)o.push(r*Math.cos(2*Math.PI*l/256)),o.push(r*Math.sin(2*Math.PI*l/256));n.addPolyline(o)}return n}function makeDrawLineLayer(e){return new PolylineLayer("DrawLineLayer",ProjShaderProgram.COORD_TYPE_XY,{color:e})}function drawLine(e){var t=mapView.getLayerById("DrawLineLayer");t&&(t.clear(),t.addPolyline([0,0,e[0],e[1]]))}function clearLine(e){var t=mapView.getLayerById("DrawLineLayer");t&&t.clear()}function getProjCenterParameter(){var e=location.search.match(/projCenter=(.*?)(&|$)/);if(e){var t=decodeURIComponent(e[1]);if(t){var a=t.split(",");if(a.length<2)return null;var n=parseFloat(a[0]),i=parseFloat(a[1]);if(isNaN(n)||isNaN(i))return null;var r=n*Math.PI/180,o=i*Math.PI/180;return r<-Math.PI/2&&(r=-Math.PI/2),Math.PI/2<r&&(r=Math.PI/2),[o,r]}}return null}function startup(e,t){var a=t||{};if(canvas=document.getElementById("webglCanvas"),gl=WebGLUtils.setupWebGL(canvas)){resizeCanvas(canvas),canvas.addEventListener("webglcontextlost",handleContextLost,!1),canvas.addEventListener("webglcontextrestored",handleContextRestored,!1),new Hammer(canvas).get("pinch").set({enable:!0}),$(canvas).hammer().on("panmove",handlePan),$(canvas).hammer().on("panstart",handlePanStart),$(canvas).hammer().on("panend pancancel",handlePanEnd),$(canvas).hammer().on("pinch",handlePinch),$(canvas).hammer().on("pinchend",handlePinchEnd),$(canvas).on("touchend",function(e){e.preventDefault()}),"doubletap"in a&&!1===a.doubletap||$(canvas).hammer().on("doubletap",handleDoubleTap),"drawLayer"in a&&!0===a.drawLayer&&$(canvas).hammer().on("tap",handleTap),"handlers"in a&&(handlers=a.handlers||{}),window.WheelEvent&&document.addEventListener("wheel",handleWheel,!1);var n="basemap"in a?a.basemap:[];0===n.length&&n.push(makeNEBaseLayer("NEBaseLayer")),init(e,n)}else alert("Failed to setup WebGL.")}function checkAndGetMousePos(e){var t=canvas.getBoundingClientRect(),a=e.clientX-t.left,n=e.clientY-t.top;return a<0||n<0?null:t.width<a||t.height<n?null:[a,n]}function checkAndGetGesturePos(e){var t=canvas.getBoundingClientRect(),a=e.gesture.center.x-t.left,n=e.gesture.center.y-t.top;return a<0||n<0?null:t.width<a||t.height<n?null:[a,n]}function handlePan(e){if(viewStatus.drag){var t=checkAndGetGesturePos(e);null!=t&&(e.preventDefault(),null!=viewStatus.dragPrevPos&&(viewStatus.isRotateMode?doRotate(t):doTranslate(t)),viewStatus.dragPrevPos=t)}}function doTranslate(e){var t=e[0]-viewStatus.dragPrevPos[0],a=e[1]-viewStatus.dragPrevPos[1];0==t&&0==a||(mapView.moveWindow(t,a),translateAnimation.recordMovement([t,a]))}function doRotate(e){var t=mapView.getViewPointFromWindow(viewStatus.dragPrevPos[0],viewStatus.dragPrevPos[1]),a=mapView.getViewPointFromWindow(e[0],e[1]),n=ProjMath.calcAngle(t[0],t[1],a[0],a[1]);ProjMath.EPSILON<Math.abs(n)&&(mapView.rotate(n),rotateAnimation.recordMovement(n))}function handlePanStart(e){viewStatus.drag=!0;var t=checkAndGetGesturePos(e);null!=t&&(e.preventDefault(),viewStatus.dragStartPos=t,translateAnimation.reset(),rotateAnimation.reset())}function handlePanEnd(e){viewStatus.drag=!1,viewStatus.dragPrevPos=null}function handleTap(e){if(!(1<e.gesture.tapCount)){var t=checkAndGetGesturePos(e);if(null!=t){e.preventDefault();var a=mapView.getViewPointFromWindow(t[0],t[1]);drawLine(a),"onTap"in handlers&&handlers.onTap.call(mapView,a)}}}function handleDoubleTap(e){var t=checkAndGetGesturePos(e);if(null!=t){e.preventDefault();var a=mapView.getLambdaPhiPointFromWindow(t[0],t[1]);viewStatus.targetLambdaPhi=a,translateAnimation.reset(),rotateAnimation.reset(),clearLine(),"onDoubleTap"in handlers&&handlers.onDoubleTap.call(mapView,a)}}function handleWheel(e){null!=checkAndGetMousePos(e)&&(e.preventDefault(),viewStatus.zoomChange-=6*e.deltaY)}function handlePinch(e){if(null!=checkAndGetGesturePos(e)){e.preventDefault(),translateAnimation.reset(),rotateAnimation.reset();var t=e.gesture.scale,a=null!=viewStatus.pinchPrevScale?viewStatus.pinchPrevScale:1,n=gl.canvas.height*(t-a);viewStatus.zoomChange+=n,viewStatus.pinchPrevScale=t}}function handlePinchEnd(e){viewStatus.pinchPrevScale=null}function handleContextLost(e){e.preventDefault(),cancelAnimFrame(requestId),mapView.resetImages()}function handleContextRestored(e){init(),requestId=requestAnimFrame(animation)}function main(e,t){startup(e,t),animation()}function animation(){requestId=requestAnimFrame(animation);var e=(new Date).getTime();if(null==prevTime&&(prevTime=e),ProjMath.EPSILON<Math.abs(viewStatus.zoomChange)){var t=5*(e-prevTime),a=viewStatus.zoomChange;t<Math.abs(viewStatus.zoomChange)&&(a=0<viewStatus.zoomChange?+t:-t),mapView.zoomWindow(a),viewStatus.zoomChange=0}var n;if(null!=viewStatus.interpolater)n=viewStatus.interpolater.getPos(e),mapView.setProjCenter(n.lp.lambda,n.lp.phi),mapView.setViewCenterPoint(n.viewPos[0],n.viewPos[1]),viewStatus.interpolater.isFinished()&&(viewStatus.interpolater=null);else if(null!=viewStatus.targetLambdaPhi){var i=mapView.getViewCenterPoint(),r=mapView.getProjCenter(),o=viewStatus.targetLambdaPhi;viewStatus.interpolater=Interpolater.create(r,o,i,[0,0],interpolateTimeSpan),viewStatus.targetLambdaPhi=null,null!=viewStatus.interpolater&&(n=viewStatus.interpolater.getPos(e),mapView.setProjCenter(n.lp.lambda,n.lp.phi),mapView.setViewCenterPoint(n.viewPos[0],n.viewPos[1]))}else if(viewStatus.drag||viewStatus.isRotateMode||!translateAnimation.active()){if(!viewStatus.drag&&viewStatus.isRotateMode&&rotateAnimation.active()){var l=rotateAnimation.animation();null!=l&&mapView.rotate(l)}}else{var s=translateAnimation.animation();null!=s&&mapView.moveWindow(s[0],s[1])}gl.viewport(0,0,gl.canvas.width,gl.canvas.height),mapView.render(),prevTime=e}var MapUI=function(){};MapUI.resetCityList=function(e){e.children("ul").not("[hidden]").children("li").removeAttr("class")},MapUI.updateMap=function(e,t){if(e.attr({class:"active"}),t){var a=e.children("a").text(),n=e.attr("data-lonlat").split(",");t.call(this,a,parseFloat(n[0]),parseFloat(n[1]))}},MapUI.createCitiesTree=function(e,t,a,n){var i=0;e.children.forEach(function(e,r){i++;var o=$("<li/>").attr({role:"presentation",countryId:i}).append($("<a/>").attr({href:"#"}).text(e.name)).click(function(e){t.children("li").removeAttr("class");var i=$(this).attr("countryId");$(this).attr({class:"active"}),a.children("ul").attr({hidden:"true"});var r=a.children("#country_"+i);r.removeAttr("hidden"),r.children("li").removeAttr("class");var o=r.children("li").first();MapUI.updateMap(o,n)});t.append(o);var l=$("<ul/>").attr({id:"country_"+i,class:"nav nav-pills nav-stacked",hidden:"true"});e.children.forEach(function(e,t){var a=$("<li/>").attr({role:"presentation","data-lonlat":e.x+","+e.y}).append($("<a/>").attr({href:"#"}).text(e.name)).click(function(e){$(this).parent().children("li").removeAttr("class"),MapUI.updateMap($(this),n)});l.append(a)}),a.append(l)})};var MapMathUtils=function(){};MapMathUtils.smoothstep=function(e,t,a){var n=ProjMath.clamp((a-e)/(t-e),0,1);return n*n*(3-2*n)},MapMathUtils.smootherstep=function(e,t,a){var n=ProjMath.clamp((a-e)/(t-e),0,1);return n*n*n*(n*(6*n-15)+10)},MapMathUtils.toUnitVector3d=function(e,t){var a=Math.cos(t);return[Math.cos(e)*a,Math.sin(e)*a,Math.sin(t)]},MapMathUtils.slerp=function(e,t,a){var n=ProjMath.clamp(e[0]*t[0]+e[1]*t[1]+e[2]*t[2],-1,1);if(1-ProjMath.EPSILON<n)return[(e[0]+t[0])/2,(e[1]+t[1])/2,(e[2]+t[2])/2];ProjMath.EPSILON;var i=Math.acos(n),r=Math.sin(i),o=Math.sin((1-a)*i)/r,l=Math.sin(a*i)/r;return[o*e[0]+l*t[0],o*e[1]+l*t[1],o*e[2]+l*t[2]]},Interpolater.create=function(e,t,a,n,i){return ProjMath.neighborPoint(e,t)?null:(Math.PI-ProjMath.EPSILON<Math.abs(t.phi-e.phi)&&(e={lambda:e.lambda,phi:e.phi+1e-4*(0<e.phi?-1:1)}),new Interpolater(e,t,a,n,i))},Interpolater.prototype.getPos=function(e){var t=0;if(null==this.startTime)this.startTime=e;else{var a=e-this.startTime;t=ProjMath.clamp(a/this.timeSpan,0,1),this.startTime+this.timeSpan<e&&(this.finished=!0)}var n=MapMathUtils.smootherstep(0,1,t),i=MapMathUtils.slerp(this.v1,this.v2,n);return{lp:ProjMath.toLambdaPhi(i),viewPos:[this.iniViewPos[0]*(1-n)+this.finViewPos[0]*n,this.iniViewPos[1]*(1-n)+this.finViewPos[1]*n]}},Interpolater.prototype.isFinished=function(){return this.finished},SlideAnimation.prototype.reset=function(){this.time=null,this.velocity=null},SlideAnimation.prototype.active=function(){return null!=this.velocity},SlideAnimation.prototype.animation=function(){var e=(new Date).getTime(),t=e-this.time,a=this.magnitudeVelocity_(this.velocity),n=this.calcFriction_(t,a);return n<=0?(this.reset(),null):(this.time=e,this.velocity=this.multiplyVelocity_(n,this.velocity),this.multiplyVelocity_(t,this.velocity))},SlideAnimation.prototype.recordMovement=function(e){var t=(new Date).getTime();if(null!=this.time){var a=t-this.time;this.velocity=this.multiplyVelocity_(1/a,e)}this.time=t},SlideAnimation.prototype.calcFriction_=function(e,t){return 1-this.alpha_*e-this.beta_*e/t},Object.setPrototypeOf(TranslateSlideAnimation.prototype,SlideAnimation.prototype),TranslateSlideAnimation.prototype.multiplyVelocity_=function(e,t){return[e*t[0],e*t[1]]},TranslateSlideAnimation.prototype.magnitudeVelocity_=function(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])},Object.setPrototypeOf(RotateSlideAnimation.prototype,SlideAnimation.prototype),RotateSlideAnimation.prototype.multiplyVelocity_=function(e,t){return e*t},RotateSlideAnimation.prototype.magnitudeVelocity_=function(e){return Math.abs(e)};var interpolateTimeSpan=1e3,gl=null,canvas=null,mapView=null,requestId=null,prevTime=null,viewStatus={drag:!1,dragPrevPos:null,pinchPrevScale:null,zoomChange:0,targetLambdaPhi:null,interpolater:null,isRotateMode:!1},translateAnimation=new TranslateSlideAnimation(.008,5e-4),rotateAnimation=new RotateSlideAnimation(.001,5e-5),handlers={};