/*!
 * FlatEarth WebGL v0.0.22  2018-01-05
 * Copyright (C) 2016-2018 T.Seno
 * Copyright (C) 2016-2018 www.flatearthlab.com
 * All rights reserved.
 */

"use strict";function init(e,a){var t=Math.PI/2,n=canvas.getBoundingClientRect();e.setProjCenter(0,t);var r={width:n.width,height:n.height};mapView=new MapView(gl,e,r),loadIcon("./center-pin.png");for(var i=0;i<a.length;i++){var o=a[i];o.visibility=0===i,mapView.addLayer(o)}mapView.addLayer(new GraticuleLayer("LatLongLayer"));var l=mapView.getViewRect(),s=(l[2]-l[0])/2;mapView.setWindow(0-s,0-s,0+s,0+s),mapView.loadData()}function resizeCanvas(e){var a=e.clientWidth,t=e.clientHeight;e.width==a&&e.height==t||(e.width=a,e.height=t)}function loadIcon(e){var a=new Image;a.onload=function(){var e=mapView.createTexture(a,!0);if(e){var t=new PointTextureLayer("centerIcon",ProjShaderProgram.COORD_TYPE_XY,e,{size:48});t.addPoint(0,0),mapView.addLayer(t)}},a.src=e}function makeNEBaseLayer(e){var a={rootNumX:2,rootNumY:1,rootTileSizeX:Math.PI,rootTileSizeY:Math.PI,numLevels:4,tileOrigin:[-Math.PI,-Math.PI/2],inverseY:!1},t={num:50,crossOrigin:"anonymous"},n={opacity:1},r=new TileTextureLayer(e,ProjShaderProgram.COORD_TYPE_DATA,n,a,t);return r.setDataLevelDef(function(e,a){var t=e[2]-e[0],n=e[3]-e[1],r=Math.sqrt(t*n);return Math.PI<=r?0:Math.PI/2<=r?1:Math.PI/4<=r?2:3}),r.setTileUrlDef(function(e,a,t){return"http://www.flatearthlab.com/data/20120925/adb12292ed/NE2_50M_SR_W/"+e+"/"+a+"/"+t+".png"}),r}function makeBMBaseLayer(e){var a={rootNumX:2,rootNumY:1,rootTileSizeX:288*Math.PI/180,rootTileSizeY:288*Math.PI/180,numLevels:4,tileOrigin:[-Math.PI,+Math.PI/2],inverseY:!0},t={num:50,crossOrigin:"anonymous"},n={opacity:1},r=new TileTextureLayer(e,ProjShaderProgram.COORD_TYPE_DATA,n,a,t);return r.setDataLevelDef(function(e,a){var t=e[2]-e[0],n=e[3]-e[1],r=Math.sqrt(t*n);return Math.PI<=r?0:Math.PI/2<=r?1:Math.PI/4<=r?2:3}),r.setTileUrlDef(function(e,a,t){return"https://gibs-c.earthdata.nasa.gov/wmts/epsg4326/best/BlueMarble_NextGeneration/default/500m/"+e+"/"+t+"/"+a+".jpeg"}),r}function makeSelectableBaseLayers(){var e=[];return e.push(makeNEBaseLayer("NEBaseLayer")),e.push(makeBMBaseLayer("BMBaseLayer")),e}function makeRadialLinesLayer(e,a,t){for(var n=new PolylineLayer(e,ProjShaderProgram.COORD_TYPE_XY,{color:t}),r=0;r<a.length;++r){for(var i=[],o=a[r]/180*Math.PI,l=Math.cos(o),s=Math.sin(o),h=0;h<=16;h++){var u=Math.PI*h/16;i.push(u*l),i.push(u*s)}n.addPolyline(i)}return n}function makeConcentricCirclesLayer(e,a,t){for(var n=new PolylineLayer(e,ProjShaderProgram.COORD_TYPE_XY,{color:t}),r=0;r<a.length;++r){for(var i=a[r]/6378.137,o=[],l=0;l<=256;l++)o.push(i*Math.cos(2*Math.PI*l/256)),o.push(i*Math.sin(2*Math.PI*l/256));n.addPolyline(o)}return n}function makeDrawLineLayer(e){return new PolylineLayer("DrawLineLayer",ProjShaderProgram.COORD_TYPE_XY,{color:e})}function drawLine(e){var a=mapView.getLayerById("DrawLineLayer");a&&(a.clear(),a.addPolyline([0,0,e[0],e[1]]))}function clearLine(e){var a=mapView.getLayerById("DrawLineLayer");a&&a.clear()}function getProjCenterParameter(){var e=location.search.match(/projCenter=(.*?)(&|$)/);if(e){var a=decodeURIComponent(e[1]);if(a){var t=a.split(",");if(t.length<2)return null;var n=parseFloat(t[0]),r=parseFloat(t[1]);if(isNaN(n)||isNaN(r))return null;var i=n*Math.PI/180,o=r*Math.PI/180;return i<-Math.PI/2&&(i=-Math.PI/2),Math.PI/2<i&&(i=Math.PI/2),[o,i]}}return null}function startup(e,a){var t=a||{};if(canvas=document.getElementById("webglCanvas"),gl=WebGLUtils.setupWebGL(canvas)){resizeCanvas(canvas),canvas.addEventListener("webglcontextlost",handleContextLost,!1),canvas.addEventListener("webglcontextrestored",handleContextRestored,!1),new Hammer(canvas).get("pinch").set({enable:!0}),$(canvas).hammer().on("panmove",handlePan),$(canvas).hammer().on("panstart",handlePanStart),$(canvas).hammer().on("panend pancancel",handlePanEnd),$(canvas).hammer().on("pinch",handlePinch),$(canvas).hammer().on("pinchend",handlePinchEnd),$(canvas).on("touchend",function(e){e.preventDefault()}),"doubletap"in t&&!1===t.doubletap||$(canvas).hammer().on("doubletap",handleDoubleTap),"drawLayer"in t&&!0===t.drawLayer&&$(canvas).hammer().on("tap",handleTap),"handlers"in t&&(handlers=t.handlers||{}),window.WheelEvent&&document.addEventListener("wheel",handleWheel,!1);var n="basemap"in t?t.basemap:[];0===n.length&&n.push(makeNEBaseLayer("NEBaseLayer")),init(e,n)}else alert("Failed to setup WebGL.")}function checkAndGetMousePos(e){var a=canvas.getBoundingClientRect(),t=e.clientX-a.left,n=e.clientY-a.top;return t<0||n<0?null:a.width<t||a.height<n?null:[t,n]}function checkAndGetGesturePos(e){var a=canvas.getBoundingClientRect(),t=e.gesture.center.x-a.left,n=e.gesture.center.y-a.top;return t<0||n<0?null:a.width<t||a.height<n?null:[t,n]}function handlePan(e){if(viewStatus.drag){var a=checkAndGetGesturePos(e);if(null!=a){if(e.preventDefault(),null!=viewStatus.dragPrevPos){var t=a[0]-viewStatus.dragPrevPos[0],n=a[1]-viewStatus.dragPrevPos[1];mapView.moveWindow(t,n)}viewStatus.dragPrevPos=a}}}function handlePanStart(e){viewStatus.drag=!0;var a=checkAndGetGesturePos(e);null!=a&&(e.preventDefault(),viewStatus.dragStartPos=a)}function handlePanEnd(e){viewStatus.drag=!1,viewStatus.dragPrevPos=null}function handleTap(e){if(!(1<e.gesture.tapCount)){var a=checkAndGetGesturePos(e);if(null!=a){e.preventDefault();var t=mapView.getViewPointFromWindow(a[0],a[1]);drawLine(t),"onTap"in handlers&&handlers.onTap.call(mapView,t)}}}function handleDoubleTap(e){var a=checkAndGetGesturePos(e);if(null!=a){e.preventDefault();var t=mapView.getLambdaPhiPointFromWindow(a[0],a[1]);viewStatus.targetLambdaPhi=t,clearLine(),"onDoubleTap"in handlers&&handlers.onDoubleTap.call(mapView,t)}}function handleWheel(e){null!=checkAndGetMousePos(e)&&(e.preventDefault(),viewStatus.zoomChange-=6*e.deltaY)}function handlePinch(e){if(null!=checkAndGetGesturePos(e)){e.preventDefault();var a=e.gesture.scale,t=null!=viewStatus.pinchPrevScale?viewStatus.pinchPrevScale:1,n=gl.canvas.height*(a-t);viewStatus.zoomChange+=n,viewStatus.pinchPrevScale=a}}function handlePinchEnd(e){viewStatus.pinchPrevScale=null}function handleContextLost(e){e.preventDefault(),cancelAnimFrame(requestId),mapView.resetImages()}function handleContextRestored(e){init(),requestId=requestAnimFrame(animation)}function main(e,a){startup(e,a),animation()}function animation(){requestId=requestAnimFrame(animation);var e=(new Date).getTime();if(null==prevTime&&(prevTime=e),ProjMath.EPSILON<Math.abs(viewStatus.zoomChange)){var a=5*(e-prevTime),t=viewStatus.zoomChange;a<Math.abs(viewStatus.zoomChange)&&(t=0<viewStatus.zoomChange?+a:-a),mapView.zoomWindow(t),viewStatus.zoomChange=0}var n;if(null!=viewStatus.interpolater)n=viewStatus.interpolater.getPos(e),mapView.setProjCenter(n.lp.lambda,n.lp.phi),mapView.setViewCenterPoint(n.viewPos[0],n.viewPos[1]),viewStatus.interpolater.isFinished()&&(viewStatus.interpolater=null);else if(null!=viewStatus.targetLambdaPhi){var r=mapView.getViewCenterPoint(),i=mapView.getProjCenter(),o=viewStatus.targetLambdaPhi;viewStatus.interpolater=Interpolater.create(i,o,r,[0,0],interpolateTimeSpan),viewStatus.targetLambdaPhi=null,null!=viewStatus.interpolater&&(n=viewStatus.interpolater.getPos(e),mapView.setProjCenter(n.lp.lambda,n.lp.phi),mapView.setViewCenterPoint(n.viewPos[0],n.viewPos[1]))}gl.viewport(0,0,gl.canvas.width,gl.canvas.height),mapView.render(),prevTime=e}var MapUI=function(){};MapUI.resetCityList=function(e){e.children("ul").not("[hidden]").children("li").removeAttr("class")},MapUI.updateMap=function(e,a){if(e.attr({class:"active"}),a){var t=e.children("a").text(),n=e.attr("data-lonlat").split(",");a.call(this,t,parseFloat(n[0]),parseFloat(n[1]))}},MapUI.createCitiesTree=function(e,a,t,n){var r=0;e.children.forEach(function(e,i){r++;var o=$("<li/>").attr({role:"presentation",countryId:r}).append($("<a/>").attr({href:"#"}).text(e.name)).click(function(e){a.children("li").removeAttr("class");var r=$(this).attr("countryId");$(this).attr({class:"active"}),t.children("ul").attr({hidden:"true"});var i=t.children("#country_"+r);i.removeAttr("hidden"),i.children("li").removeAttr("class");var o=i.children("li").first();MapUI.updateMap(o,n)});a.append(o);var l=$("<ul/>").attr({id:"country_"+r,class:"nav nav-pills nav-stacked",hidden:"true"});e.children.forEach(function(e,a){var t=$("<li/>").attr({role:"presentation","data-lonlat":e.x+","+e.y}).append($("<a/>").attr({href:"#"}).text(e.name)).click(function(e){$(this).parent().children("li").removeAttr("class"),MapUI.updateMap($(this),n)});l.append(t)}),t.append(l)})};var MapMathUtils=function(){};MapMathUtils.smoothstep=function(e,a,t){var n=ProjMath.clamp((t-e)/(a-e),0,1);return n*n*(3-2*n)},MapMathUtils.smootherstep=function(e,a,t){var n=ProjMath.clamp((t-e)/(a-e),0,1);return n*n*n*(n*(6*n-15)+10)},MapMathUtils.toUnitVector3d=function(e,a){var t=Math.cos(a);return[Math.cos(e)*t,Math.sin(e)*t,Math.sin(a)]},MapMathUtils.slerp=function(e,a,t){var n=ProjMath.clamp(e[0]*a[0]+e[1]*a[1]+e[2]*a[2],-1,1);if(1-ProjMath.EPSILON<n)return[(e[0]+a[0])/2,(e[1]+a[1])/2,(e[2]+a[2])/2];ProjMath.EPSILON;var r=Math.acos(n),i=Math.sin(r),o=Math.sin((1-t)*r)/i,l=Math.sin(t*r)/i;return[o*e[0]+l*a[0],o*e[1]+l*a[1],o*e[2]+l*a[2]]};var Interpolater=function(e,a,t,n,r){this.v1=MapMathUtils.toUnitVector3d(e.lambda,e.phi),this.v2=MapMathUtils.toUnitVector3d(a.lambda,a.phi),this.iniViewPos=t,this.finViewPos=n,this.timeSpan=r,this.startTime=null,this.finished=!1};Interpolater.create=function(e,a,t,n,r){return ProjMath.neighborPoint(e,a)?null:(Math.PI-ProjMath.EPSILON<Math.abs(a.phi-e.phi)&&(e={lambda:e.lambda,phi:e.phi+1e-4*(0<e.phi?-1:1)}),new Interpolater(e,a,t,n,r))},Interpolater.prototype.getPos=function(e){var a=0;if(null==this.startTime)this.startTime=e;else{var t=e-this.startTime;a=ProjMath.clamp(t/this.timeSpan,0,1),this.startTime+this.timeSpan<e&&(this.finished=!0)}var n=MapMathUtils.smootherstep(0,1,a),r=MapMathUtils.slerp(this.v1,this.v2,n);return{lp:ProjMath.toLambdaPhi(r),viewPos:[this.iniViewPos[0]*(1-n)+this.finViewPos[0]*n,this.iniViewPos[1]*(1-n)+this.finViewPos[1]*n]}},Interpolater.prototype.isFinished=function(){return this.finished};var interpolateTimeSpan=1e3,gl=null,canvas=null,mapView=null,requestId=null,prevTime=null,viewStatus={drag:!1,dragPrevPos:null,pinchPrevScale:null,zoomChange:0,targetLambdaPhi:null,interpolater:null},handlers={};